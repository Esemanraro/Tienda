{% extends 'base.html' %}

{% block title %}Gestion de Inventario{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>Gestion de Inventario</h1>
        <div class="admin-actions">
            <button class="admin-btn" onclick="showAddToyModal()">
                <i class="fas fa-plus"></i> Agregar Juguete
            </button>
            <a class="admin-btn" href="{{ url_for('admin.bulk_upload_toys') }}">
                <i class="fas fa-upload"></i> Carga masiva
            </a>
        </div>
    </div>

    <!-- Filtros y Busqueda -->
    <div class="filter-section">
        <input type="text" id="toySearch" placeholder="Buscar juguetes..." class="search-input">
        <select id="categoryFilter" class="filter-select">
            <option value="all">Todas las categorias</option>
            {% for value, label in toy_form.toy_type.choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Grid de Juguetes -->
    <div class="toys-grid">
        {% for toy in toys %}
        <div class="toy-card" id="toy-{{ toy.id }}">
            <div class="toy-image">
                <img src="{{ url_for('static', filename=toy.image_url if toy.image_url else 'images/toys/default_toy.png') }}" alt="{{ toy.name }}">
                <div class="stock-controls">
                    <button class="stock-btn" onclick="adjustStock({{ toy.id }}, -1)">-</button>
                    <span class="stock-count" id="stock-{{ toy.id }}">{{ toy.stock }}</span>
                    <button class="stock-btn" onclick="adjustStock({{ toy.id }}, 1)">+</button>
                    <button class="stock-btn delete-btn" onclick="deleteToy({{ toy.id }})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="toy-info">
                <h3>{{ toy.name }}</h3>
                <p class="toy-price">{{ toy.price }} ALOHA Dolares</p>
                <p class="toy-category">{{ toy.category }}</p>
                <p class="toy-description">{{ toy.description }}</p>
                <div class="toy-centers">
                    {% if toy.centers and toy.centers|length > 0 %}
                        {% for tc in toy.centers %}
                            <span class="center-chip">{{ tc.center|title }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="center-chip center-all">Todos los centros</span>
                    {% endif %}
                </div>
                <div style="margin-top:.5rem; display:flex; gap:.5rem;">
                    <button class="admin-btn" style="padding:.4rem .6rem;font-size:.85rem" onclick="showEditToyModal({{ toy.id }})">Editar</button>
                    <button class="admin-btn" style="padding:.4rem .6rem;font-size:.85rem" onclick="openCentersModal({{ toy.id }}, '{{ toy.name|e }}')">Editar Centros</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Modal Agregar Juguete -->
    <div id="addToyModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2>Agregar Juguete</h2>
            <form id="addToyForm" enctype="multipart/form-data">
                {{ toy_form.hidden_tag() }}
                <div class="form-group">
                    <label for="toyName">Nombre del Juguete</label>
                    <input type="text" id="toyName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="toyDescription">Descripcion</label>
                    <textarea id="toyDescription" name="description" required></textarea>
                </div>
                <div class="form-group">
                    <label for="toyPrice">Precio (ALOHA Dolares)</label>
                    <input type="number" id="toyPrice" name="price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="toyStock">Stock</label>
                    <input type="number" id="toyStock" name="stock" min="0" required>
                </div>
                <div class="form-group">
                    <label for="toyCategory">Categoria de Edad</label>
                    {{ toy_form.age_range(id='toyAge') }}
                </div>
                <div class="form-group">
                    <label for="toyType">Categoria de Juguete</label>
                    {{ toy_form.toy_type(id='toyType') }}
                </div>
                <div class="form-group">
                    <label for="toyGender">Categoria de Genero</label>
                    {{ toy_form.gender(id='toyGender') }}
                </div>
                <div class="form-group">
                    <label>Centros disponibles</label>
                    <div class="centers-group" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.5rem;">
                        <label><input type="checkbox" name="centers" value="aguadulce"> Aguadulce</label>
                        <label><input type="checkbox" name="centers" value="anclas mall"> Anclas Mall</label>
                        <label><input type="checkbox" name="centers" value="brisas del golf"> Brisas del Golf</label>
                        <label><input type="checkbox" name="centers" value="calle 50"> Calle 50</label>
                        <label><input type="checkbox" name="centers" value="costa del este"> Costa del Este</label>
                        <label><input type="checkbox" name="centers" value="david"> David</label>
                        <label><input type="checkbox" name="centers" value="chitre"> Chitre</label>
                        <label><input type="checkbox" name="centers" value="santiago"> Santiago</label>
                        <label><input type="checkbox" name="centers" value="condado del rey"> Condado Del Rey</label>
                        <label><input type="checkbox" name="centers" value="centro autorizado arraijan"> Centro Autorizado Arraijan</label>
                        <label><input type="checkbox" name="centers" value="escuela bet yacoov"> Escuela Bet Yacoov</label>
                        <label><input type="checkbox" name="centers" value="escuela de la salle"> Escuela De La Salle</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="toyImage">Imagen</label>
                    <input type="file" id="toyImage" name="image" accept="image/*" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Guardar</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('addToyModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Juguete -->
<div id="editToyModal" class="modal" style="display:none;">
    <div class="modal-content">
        <h2>Editar Juguete</h2>
        <form id="editToyForm">
            <input type="hidden" id="editToyId" name="toy_id" />
            <div class="form-group">
                <label for="editToyName">Nombre</label>
                <input type="text" id="editToyName" name="name" required />
            </div>
            <div class="form-group">
                <label for="editToyDescription">Descripción</label>
                <textarea id="editToyDescription" name="description" required></textarea>
            </div>
            <div class="form-group">
                <label for="editToyPrice">Precio (ALOHA Dólares)</label>
                <input type="number" step="0.01" id="editToyPrice" name="price" required />
            </div>
            <div class="form-group">
                <label for="editToyCategory">Categoría</label>
                <select id="editToyCategory" name="category">
                    <option value="">(Sin categoría)</option>
                    {% for value, label in toy_form.category.choices %}
                        <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="editToyStock">Stock</label>
                <input type="number" min="0" id="editToyStock" name="stock" required />
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closeModal('editToyModal')">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar Centros -->
<div id="editCentersModal" class="modal" style="display:none;">
    <div class="modal-content">
        <h2>Editar Centros</h2>
        <p id="centersToyName" style="opacity:.8;margin-top:-.5rem"></p>
        <form id="editCentersForm">
            <input type="hidden" id="centersToyId" name="toy_id" />
            <div class="centers-group" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.5rem;max-height:260px;overflow:auto;border:1px solid var(--border-color);padding:.6rem;border-radius:6px;">
                <label><input type="checkbox" name="centers" value="aguadulce"> Aguadulce</label>
                <label><input type="checkbox" name="centers" value="anclas mall"> Anclas Mall</label>
                <label><input type="checkbox" name="centers" value="brisas del golf"> Brisas del Golf</label>
                <label><input type="checkbox" name="centers" value="calle 50"> Calle 50</label>
                <label><input type="checkbox" name="centers" value="costa del este"> Costa del Este</label>
                <label><input type="checkbox" name="centers" value="david"> David</label>
                <label><input type="checkbox" name="centers" value="chitre"> Chitre</label>
                <label><input type="checkbox" name="centers" value="santiago"> Santiago</label>
                <label><input type="checkbox" name="centers" value="condado del rey"> Condado Del Rey</label>
                <label><input type="checkbox" name="centers" value="centro autorizado arraijan"> Centro Autorizado Arraijan</label>
                <label><input type="checkbox" name="centers" value="escuela bet yacoov"> Escuela Bet Yacoov</label>
                <label><input type="checkbox" name="centers" value="escuela de la salle"> Escuela De La Salle</label>
            </div>
            <div class="form-actions" style="margin-top:1rem;display:flex;gap:.5rem;justify-content:flex-end;">
                <button type="button" class="btn-secondary" onclick="closeModal('editCentersModal')">Cancelar</button>
                <button type="button" class="btn-primary" onclick="saveCenters()">Guardar</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Modales responsivos */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    z-index: 1000;
}
.modal-content {
    background: var(--card-bg);
    color: var(--text-color);
    width: 100%;
    max-width: 520px;
    border-radius: 12px;
    box-shadow: var(--box-shadow);
    padding: 1rem 1.2rem;
    max-height: 90vh;
    overflow: auto;
}
.form-actions { display:flex; gap:.5rem; justify-content:flex-end; }
.btn-primary {
    background: var(--primary-color);
    color: #fff;
    border: none;
    padding: .6rem 1rem;
    border-radius: 8px;
    cursor: pointer;
}
.btn-secondary {
    background: #e0e0e0;
    color: #222;
    border: none;
    padding: .6rem 1rem;
    border-radius: 8px;
    cursor: pointer;
}
@media (max-width: 480px) {
    .modal-content { max-width: 100%; padding: 1rem; }
}

.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.toys-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.toy-card {
    background: var(--card-bg);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--box-shadow);
    transition: transform 0.2s;
}

.toy-card:hover {
    transform: translateY(-5px);
}

.toy-image {
    position: relative;
    padding-top: 75%;
}

.toy-image img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.stock-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.stock-btn {
    background: rgba(0, 0, 0, 0.6);
    color: #fff;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
}

.stock-count {
    background: rgba(0, 0, 0, 0.6);
    color: #fff;
    padding: 0 0.4rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.delete-btn {
    background: rgba(244, 67, 54, 0.8);
}

.toy-info {
    padding: 1rem;
}

.toy-info h3 {
    margin: 0;
    font-size: 1.2rem;
    color: var(--primary-color);
}

.toy-price {
    font-weight: bold;
    color: var(--secondary-color);
}

.toy-category {
    font-size: 0.9rem;
    color: var(--text-color);
    opacity: 0.8;
}

.toy-description {
    font-size: 0.9rem;
    margin-top: 0.5rem;
    color: var(--text-color);
}

.toy-centers { margin-top: .5rem; display: flex; flex-wrap: wrap; gap: .3rem; }
.center-chip {
    display: inline-block;
    background: rgba(0,0,0,0.06);
    color: var(--text-color);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: .15rem .5rem;
    font-size: .8rem;
}
.center-chip.center-all {
    background: rgba(76,175,80,0.08);
    border-color: rgba(76,175,80,0.2);
}

.form-group textarea {
    width: 100%;
    min-height: 100px;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    background: var(--input-bg);
    color: var(--text-color);
    resize: vertical;
}

.form-group input[type="file"] {
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    background: var(--input-bg);
    color: var(--text-color);
    width: 100%;
}
</style>

<script>
function showAddToyModal() {
    const m = document.getElementById('addToyModal');
    if (m) m.style.display = 'flex';
}

function closeModal(modalId) {
    const m = document.getElementById(modalId);
    if (m) m.style.display = 'none';
}

// Manejo del formulario de agregar juguete
document.getElementById('addToyForm').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    formData.set('stock', document.getElementById('toyStock').value);
    formData.set('csrf_token', document.querySelector('input[name="csrf_token"]').value);
    try {
        const response = await fetch('/admin/toys/add', {
            method: 'POST',
            body: formData
        });
        if (response.ok) {
            closeModal('addToyModal');
            location.reload();
        } else {
            alert('Error al guardar el juguete');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar el juguete');
    }
};

// Modal Editar Juguete
async function showEditToyModal(toyId) {
    try {
        const resp = await fetch(`/admin/edit_toy/${toyId}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (!resp.ok) throw new Error('No se pudo cargar el juguete');
        const toy = await resp.json();
        // Poblar campos
        document.getElementById('editToyId').value = toy.id;
        document.getElementById('editToyName').value = toy.name || '';
        document.getElementById('editToyDescription').value = toy.description || '';
        document.getElementById('editToyPrice').value = toy.price != null ? toy.price : '';
        const sel = document.getElementById('editToyCategory');
        if (sel) sel.value = (toy.category || '');
        document.getElementById('editToyStock').value = toy.stock != null ? toy.stock : '';
        document.getElementById('editToyModal').style.display = 'flex';
    } catch (e) {
        alert(e.message || 'Error cargando juguete');
    }
}

document.getElementById('editToyForm').onsubmit = async function(e) {
    e.preventDefault();
    const toyId = document.getElementById('editToyId').value;
    const form = new FormData(this);
    form.set('csrf_token', getCsrfToken());
    try {
        const resp = await fetch(`/admin/edit_toy/${toyId}`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: form
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || data.success === false) throw new Error((data && data.message) || 'Error al actualizar');
        // Actualizar tarjeta en UI
        const card = document.getElementById(`toy-${toyId}`);
        if (card) {
            const nameEl = card.querySelector('h3');
            const descEl = card.querySelector('.toy-description');
            const priceEl = card.querySelector('.toy-price');
            const stockEl = card.querySelector(`#stock-${toyId}`);
            if (nameEl) nameEl.textContent = form.get('name');
            if (descEl) descEl.textContent = form.get('description');
            if (priceEl) priceEl.textContent = `${parseFloat(form.get('price')||0).toFixed(2)} ALOHA Dolares`;
            if (stockEl) stockEl.textContent = form.get('stock');
            const catEl = card.querySelector('.toy-category');
            if (catEl) catEl.textContent = form.get('category') || '';
        }
        closeModal('editToyModal');
    } catch (err) {
        alert(err.message || 'Error al guardar cambios');
    }
}

// Busqueda y filtrado
document.getElementById('toySearch').oninput = function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const cards = document.querySelectorAll('.toy-card');
    
    cards.forEach(card => {
        const name = card.querySelector('h3').textContent.toLowerCase();
        const description = card.querySelector('.toy-description').textContent.toLowerCase();
        const matches = name.includes(searchTerm) || description.includes(searchTerm);
        card.style.display = matches ? 'block' : 'none';
    });
};

document.getElementById('categoryFilter').onchange = function(e) {
    const category = e.target.value;
    const cards = document.querySelectorAll('.toy-card');

    cards.forEach(card => {
        const toyCategory = card.querySelector('.toy-category').textContent;
        card.style.display = (category === 'all' || toyCategory === category) ? 'block' : 'none';
    });
};

function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

async function adjustStock(toyId, delta) {
    try {
        const response = await fetch(`/admin/toys/${toyId}/stock`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ delta: delta })
        });
        const data = await response.json();
        if (data.success) {
            const el = document.getElementById(`stock-${toyId}`);
            if (el) el.textContent = data.stock;
        } else {
            alert(data.message || 'Error actualizando stock');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error actualizando stock');
    }
}

async function deleteToy(toyId) {
    if (!confirm('?Eliminar este juguete?')) return;
    try {
        const response = await fetch(`/admin/delete_toy/${toyId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        const data = await response.json();
        if (data.success) {
            const card = document.getElementById(`toy-${toyId}`);
            if (card) card.remove();
        } else {
            alert(data.message || 'Error al eliminar el juguete');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar el juguete');
    }
}

// --------- Editar Centros (Disponibilidad) ---------
function openCentersModal(toyId, toyName) {
    document.getElementById('centersToyId').value = toyId;
    document.getElementById('centersToyName').textContent = `Juguete: ${toyName}`;

    // Desmarcar todo
    document.querySelectorAll('#editCentersForm input[name="centers"]').forEach(cb => cb.checked = false);

    // Cargar centros actuales
    fetch(`/admin/toys/${toyId}/centers`, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && Array.isArray(data.centers)) {
            const set = new Set(data.centers.map(c => (c || '').toLowerCase()));
            const boxes = document.querySelectorAll('#editCentersForm input[name="centers"]');
            if (set.size === 0) {
                // Interpretar como "todos los centros": marcar todos
                boxes.forEach(cb => cb.checked = true);
            } else {
                boxes.forEach(cb => { cb.checked = set.has(cb.value.toLowerCase()); });
            }
        }
        document.getElementById('editCentersModal').style.display = 'flex';
    })
    .catch(() => {
        document.getElementById('editCentersModal').style.display = 'flex';
    });
}

function saveCenters() {
    const toyId = document.getElementById('centersToyId').value;
    const selected = Array.from(document.querySelectorAll('#editCentersForm input[name="centers"]:checked')).map(cb => cb.value);
    fetch(`/admin/toys/${toyId}/centers`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ centers: selected })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Centros actualizados');
            closeModal('editCentersModal');
        } else {
            alert(data.message || 'Error al actualizar centros');
        }
    })
    .catch(() => alert('Error de conexión'));
}
</script>
{% endblock %}

